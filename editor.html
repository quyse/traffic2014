<!doctype html>
<html>
	<head>
		<title>Traffic Editor</title>
		<link href="jquery-ui/jquery-ui.min.css" rel="stylesheet">
		<link href="jquery-ui/jquery-ui.structure.min.css" rel="stylesheet">
		<link href="jquery-ui/jquery-ui.theme.min.css" rel="stylesheet">
		<script type="text/javascript" src="jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="jquery-ui/jquery-ui.min.js"></script>
		<script type="text/javascript" src="engine.js"></script>
		<style>
			#toolsContainer {
				position: absolute;
				left: 0;
				top: 0;
				width: 300px;
				bottom: 0;
				border-right: 1px solid black;
			}
			#canvasContainerContainer {
				position: absolute;
				left: 300px;
				top: 0;
				right: 0;
				bottom: 0;
				margin: 0;
				padding: 0;
				overflow: hidden;
				background-color: #f00;
			}
			#canvasContainer {
				position: absolute;
				left: 0;
				top: 0;
				margin: 0;
				padding: 0;
				background-color: #fff;
			}
			#canvas {
				margin: 0;
				padding: 0;
			}

			.marker {
				position: absolute;
			}
			.vertexMarker.selected {
				background-color: #f00;
			}
			.edgeMarker.selected {
				background-color: #0f0;
			}
		</style>
	</head>
	<body>
		<div id="toolsContainer">
			<h1>Traffic Editor</h1>
			<div>
				<input type="file" id="file" />
			</div>
			<div>
				<input type="button" id="buttonLoadFile" value="load" />
				<input type="button" id="buttonDeserialize" value="deserialize" />
				<input type="button" id="buttonSerialize" value="serialize" />
			</div>
			<div>
				<textarea id="text"></textarea>
			</div>
			<div id="radioMode">
				<input type="radio" name="radioMode" id="radioModeNormal" checked="checked" value="normal" /><label for="radioModeNormal">normal mode</label>
				<input type="radio" name="radioMode" id="radioModeCreateVertex" value="createVertex" /><label for="radioModeCreateVertex">create vertex (RIGHT MOUSE)</label>
				<input type="radio" name="radioMode" id="radioModeCreateEdge" value="createEdge" /><label for="radioModeCreateEdge">create edge (RIGHT MOUSE)</label>
			</div>
			<div>
				<h2>Vertex</h2>
				<input type="button" id="buttonDeleteVertex" value="delete" />
				<input type="button" id="buttonClearFirstVertex" value="clear first" />
			</div>
			<div>
				<h2>Edge</h2>
				<input type="button" id="buttonDeleteEdge" value="delete" />
			</div>
		</div>
		<div id="canvasContainerContainer">
			<div id="canvasContainer">
				<canvas id="canvas" width="4096" height="4096"></canvas>
			</div>
		</div>
		<script type="text/javascript">
			var canvasContainer = $('#canvasContainer');
			var canvas = $('#canvas')[0];
			var canvasWidth = canvas.width;
			var canvasHeight = canvas.height;
			var context = canvas.getContext('2d');

			var engine = new Engine(canvas);

			var graph = new Engine.Graph();

			$('#buttonLoadFile').click(function() {
				var file = $('#file')[0].files[0];
				var fileReader = new FileReader();
				fileReader.onload = function(e) {
					var text = e.target.result;
					$('#text').val(text);
					loadGraph(text);
				};
				fileReader.readAsText(file);
			});

			$('#buttonDeserialize').click(function() {
				loadGraph($('#text').val());
			});

			$('#buttonSerialize').click(function() {
				$('#text').val(JSON.stringify(graph.serialize(), null, '\t'));
			});

			$('#canvasContainer').draggable();

			$('#radioMode').buttonset();

			function loadGraph(text) {
				graph = Engine.Graph.deserialize(JSON.parse(text));
				loadMarkers();
				drawGraph();
			}

			function drawGraph() {
				context.clearRect(0, 0, canvasWidth, canvasHeight);
				engine.drawGraph(graph);
			};

			function getMode() {
				return $('input[name=radioMode]:checked', '#radioMode').val();
			}

			$(document).ready(function() {
				document.oncontextmenu = function() { return false; }
			});

			$('#canvas').mousedown(function(e) {
				if(getMode() != 'createVertex' || e.button != 2)
					return;

				var parentOffset = $(this).parent().offset();

				var vertex = new Engine.Vertex();
				vertex.positionX = e.pageX - parentOffset.left;
				vertex.positionY = e.pageY - parentOffset.top;
				vertex.directionX = 0;
				vertex.directionY = 1;
				graph.addVertex(vertex);
				addVertex(vertex);
			});

			var firstVertexForCreateEdge = null;

			$('#buttonClearFirstVertex').click(function() {
				firstVertexForCreateEdge = null;
			});

			function addVertex(vertex) {
				// position marker
				var div = $('<div class="marker vertexMarker vertexMarker' + vertex.id + ' ui-icon ui-icon-radio-on"></div>');
				div.appendTo(canvasContainer);
				div.css('left', vertex.positionX - 8);
				div.css('top', vertex.positionY - 8);
				div.mousedown(function(e) {
					selectVertex(vertex);
				});
				div.draggable({
					drag: function(event, ui) {
						vertex.positionX = ui.position.left + 8;
						vertex.positionY = ui.position.top + 8;

						$('.vertexBezierMarker' + vertex.id).map(function() {
							this.update();
						});

						graph.update();
						drawGraph();
					}
				});
				div.mousedown(function(e) {
					if(getMode() != 'createEdge' || e.button != 2)
						return;

					if(firstVertexForCreateEdge) {
						var edge = new Engine.Edge();
						edge.vertexA = firstVertexForCreateEdge;
						firstVertexForCreateEdge = null;
						edge.vertexB = vertex;
						edge.leftEdge = null;
						edge.rightEdge = null;
						edge.bezierLengthA = 50;
						edge.bezierLengthB = -50;
						graph.addEdge(edge);
						edge.updatePoints();
						addEdge(edge);
						drawGraph();
					} else {
						firstVertexForCreateEdge = vertex;
					}
				});
			}

			function addEdge(edge) {
				var addMarker = function(vertex, bezierLengthProperty, bezierMult) {
					var div = $('<div class="marker edgeMarker edgeForwardMarker edgeMarker' + edge.id + ' vertexBezierMarker' + vertex.id + ' ui-icon ui-icon-bullet"></div>');
					div.appendTo(canvasContainer);
					div[0].update = function() {
						div.css('left', vertex.positionX + vertex.directionX * edge[bezierLengthProperty] - 8);
						div.css('top', vertex.positionY + vertex.directionY * edge[bezierLengthProperty] - 8);
					};
					div[0].update();
					div.mousedown(function(e) {
						selectEdge(edge);
					});
					div.draggable({
						drag: function(event, ui) {
							var dirX = ui.position.left + 8 - vertex.positionX;
							var dirY = ui.position.top + 8 - vertex.positionY;
							var dirLength = Math.sqrt(dirX * dirX + dirY * dirY);
							dirX /= dirLength;
							dirY /= dirLength;
							edge[bezierLengthProperty] = dirLength * bezierMult;
							vertex.directionX = dirX * bezierMult;
							vertex.directionY = dirY * bezierMult;

							$('.vertexBezierMarker' + vertex.id).map(function() {
								this.update();
							});

							graph.update();
							drawGraph();
						}
					});
				};
				// backward marker
				addMarker(edge.vertexA, 'bezierLengthA', 1);
				// forward marker
				addMarker(edge.vertexB, 'bezierLengthB', -1);
			}

			function loadMarkers() {
				$('.marker').remove();

				// vertex markers
				for(var i = 0; i < graph.vertices.length; ++i)
					addVertex(graph.vertices[i]);

				for(var i = 0; i < graph.edges.length; ++i)
					addEdge(graph.edges[i]);
			}

			var selectedVertex = null;
			function selectVertex(vertex) {
				if(selectedVertex)
					$('.vertexMarker').removeClass('selected');
				selectedVertex = vertex;
				if(selectedVertex)
					$('.vertexMarker' + selectedVertex.id).addClass('selected');
			}

			var selectedEdge = null;
			function selectEdge(edge) {
				if(selectedEdge)
					$('.edgeMarker').removeClass('selected');
				selectedEdge = edge;
				if(selectedEdge)
					$('.edgeMarker' + edge.id).addClass('selected');
			}

			function removeVertex(vertex) {
				for(var i = 0; i < graph.edges.length; ++i)
					if(graph.edges[i].vertexA.id == vertex.id || graph.edges[i].vertexB.id == vertex.id)
						removeEdge(graph.edges[i--]);
				graph.removeVertex(vertex);
				$('.vertexMarker' + vertex.id).remove();
				if(selectedVertex && selectedVertex.id == vertex.id)
					selectVertex(null);
			}
			$('#buttonDeleteVertex').click(function() {
				if(selectedVertex) {
					removeVertex(selectedVertex);
					drawGraph();
				}
			});

			function removeEdge(edge) {
				graph.removeEdge(edge);
				$('.edgeMarker' + edge.id).remove();
				if(selectedEdge && selectedEdge.id == edge.id)
					selectEdge(null);
			}
			$('#buttonDeleteEdge').click(function() {
				if(selectedEdge) {
					removeEdge(selectedEdge);
					drawGraph();
				}
			});
		</script>
	</body>
</html>
